/*! media-credit media-credit-attachment-details.js 2019-05-19 6:51:01 PM */

jQuery(function(o){"use strict";var r=mundschenk.mediaCredit||{};r.autoComplete=function(i,e,d){function n(e){i.model.set({mediaCreditAuthorID:"",mediaCreditAuthorDisplay:e,mediaCreditText:e}),d&&i.model.save()}return i.$el.find(e).autocomplete({autoFocus:!0,minLength:2,source:r.names||(r.names=_.map(r.id,function(e,t){return{id:t,value:e,label:e}})),select:function(e,t){return o(this).attr("value",t.item.value),i.model.set({mediaCreditAuthorID:t.item.id,mediaCreditAuthorDisplay:t.item.value,mediaCreditText:t.item.value}),d&&i.model.save(),!1},response:function(e,t){var a;0===t.content.length&&(a=o(this).val())!==i.model.get("mediaCreditAuthorDisplay")&&n(a)},open:function(){return o(this).autocomplete("widget").css("z-index",2e6),!1}}).click(function(){this.select()}).change(function(e){var t=o(this),a=t.val();(r.options.noDefaultCredit||!1)&&""===a&&""===i.model.get("mediaCreditAuthorID")?(i.model.set({mediaCreditAuthorID:i.model.get("author"),mediaCreditAuthorDisplay:i.model.get("authorName"),mediaCreditText:i.model.get("authorName")}),d&&i.model.save(),t.val("").attr("placeholder",i.model.get("mediaCredit.placeholder")),e.stopImmediatePropagation(),e.preventDefault()):a!==i.model.get("mediaCreditAuthorDisplay")&&(n(a),e.stopImmediatePropagation(),e.preventDefault())})},wp.media.view.Attachment.Details&&(r.AttachmentDetails=wp.media.view.Attachment.Details.extend({template:function(e){return wp.media.template("attachment-details")(e)+wp.media.template("media-credit-attachment-details")(e)},render:function(){var e,t=r.options.noDefaultCredit||!1;wp.media.view.Attachment.prototype.render.apply(this,[]),e=r.autoComplete(this,'label[data-setting="mediaCreditText"] input[type="text"]',!0),t?(e.autocomplete("disable"),""!==this.model.get("mediaCreditAuthorID")&&e.val("").attr("placeholder",this.model.get("mediaCredit.placeholder"))):e.autocomplete("enable")},updateSetting:function(e){var t=o(e.target);t.is('input[type="checkbox"]')&&(e.target.value=t.prop("checked")?1:0),wp.media.view.Attachment.prototype.updateSetting.apply(this,[e])}}),wp.media.view.Attachment.Details.prototype=r.AttachmentDetails.prototype),wp.media.view.Attachment.Details.TwoColumn&&(r.AttachmentDetailsTwoColumn=wp.media.view.Attachment.Details.TwoColumn.extend({template:function(e){var t=o(o.parseHTML(wp.media.template("attachment-details-two-column")(e)));return o(wp.media.template("media-credit-attachment-details")(e)).insertAfter(t.find(".attachment-compat").prevAll("*[data-setting]")[0]),t},updateSetting:function(e){wp.media.view.Attachment.Details.prototype.updateSetting.apply(this,[e])}}),wp.media.view.Attachment.Details.TwoColumn.prototype=r.AttachmentDetailsTwoColumn.prototype),wp.media.model.Attachment&&(r.AttachmentModel=wp.media.model.Attachment.extend({sync:function(e,a,t){var i,d,n={};return _.isUndefined(this.id)?o.Deferred().rejectWith(this).promise():(d=this.id,"update"===e&&a.hasChanged()&&(r.options.noDefaultCredit&&""===a.changed.mediaCreditText&&""!==a.get("mediaCreditAuthorID")&&delete a.changed.mediaCreditText,_.each(a.changed,function(e,t){0===t.indexOf("mediaCredit")&&("mediaCreditAuthorID"===t?n.user_id=this.get(t)||0:"mediaCreditText"===t?n.freeform=this.get(t):"mediaCreditLink"===t?n.url=this.get(t):"mediaCreditNoFollow"===t&&(n.flags=n.flags||{},n.flags.nofollow=this.get(t)),delete a.changed[t])},this),0<_.size(n)&&((i=new wp.api.models.Media({id:this.id})).fetch(),i.set("media_credit",{raw:n}),i.save({status:"publish"}),this.updateMediaCreditInEditorContent(o("textarea#content").val(),d,a))),"update"!==e||a.hasChanged()?this.constructor.__super__.sync.apply(this,[e,a,t]):o.Deferred().rejectWith(this).promise())},updateMediaCreditInEditorContent:function(a,e,t){a&&wp.apiRequest({namespace:"media-credit/v1",endpoint:"replace_in_content",data:{content:a,attachment_id:e||0,author_id:t.get("mediaCreditAuthorID")||0,freeform:t.get("mediaCreditText"),url:t.get("mediaCreditLink"),nofollow:t.get("mediaCreditNoFollow")},success:function(e){var t;a!==e&&((t=tinymce.get("content"))&&t instanceof tinymce.Editor&&o("#wp-content-wrap").hasClass("tmce-active")?(t.setContent(e),t.save({no_events:!0})):o("textarea#content").val(e))}})}}),wp.media.model.Attachment.prototype=r.AttachmentModel.prototype)});